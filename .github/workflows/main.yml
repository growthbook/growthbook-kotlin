name: Release

on:
  workflow_dispatch

env:
  LIB_VERSION: 6.0.1

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
      with:
        clean: 'true'
        fetch-depth: 0
    - name: Install GitVersion
      uses: gittools/actions/gitversion/setup@v0.9.7
      with:
        versionSpec: '5.x'
    - uses: actions/setup-java@v3
      with:
        java-version: 17
        distribution: 'temurin'
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
    - name: Determine Version
      id: gitversion
      uses: gittools/actions/gitversion/execute@v0.9.7
      with:
        useConfigFile: true
        configFilePath: ./.github/gitversion.yml
    - name: Gradle clean
      run: ./gradlew clean --info
    - name: Build with Gradle
      run: ./gradlew -Pversion=$LIB_VERSION kotlinUpgradeYarnLock :GrowthBook:build --info
    # Skip release creation - we just want the bundle for manual upload
    - name: Build signed artifacts for Maven Central
      run: |
        GPG_PRIVATE_KEY="${{secrets.GPG_PRIVATE_KEY}}" GPG_PRIVATE_PASSWORD="${{secrets.GPG_PRIVATE_PASSWORD}}" ./gradlew -Pversion=$LIB_VERSION :GrowthBook:publishToMavenLocal
    - name: Create Maven Central deployment bundle
      run: |
        echo "üì¶ Creating deployment bundle for Manual Upload to Central Portal..."
        cd ~/.m2/repository/io/github/growthbook
        echo "üîç All 6.0.1 artifacts that will be included:"
        find . -name "*6.0.1*" -type f | sort
        echo ""
        echo "üìä Artifact count by type:"
        find . -name "*6.0.1*" -type f | grep -E '\.(jar|aar|pom|asc|md5|sha1|klib|module)$' | sed 's/.*\.//' | sort | uniq -c
        echo ""
        zip -r /tmp/growthbook-6.0.1-central-bundle.zip . -i "*6.0.1*"
        ls -la /tmp/growthbook-6.0.1-central-bundle.zip
        echo ""
        echo "‚úÖ Bundle created with $(find . -name "*6.0.1*" -type f | wc -l) files"
    - name: Upload Maven Central bundle
      uses: actions/upload-artifact@v4
      with:
        name: growthbook-6.0.1-maven-central-bundle
        path: /tmp/growthbook-6.0.1-central-bundle.zip
        retention-days: 7
    # Release asset uploads removed - we only need the bundle artifact
